# Agent User Flow & Prompt Construction

## Overview

This document details how the LLM agent processes user queries, constructs prompts, manages conversation history, and executes tools in the Neurogabber system.

---

## ðŸ”„ Agent Execution Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER INTERACTION FLOW                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User Types Message
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FRONTEND: panel_app.py                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  respond() function                                                     â”‚ â”‚
â”‚  â”‚  â€¢ Receives user input                                                  â”‚ â”‚
â”‚  â”‚  â€¢ Chooses streaming or non-streaming path                             â”‚ â”‚
â”‚  â”‚  â€¢ Calls agent_call() or streams from /agent/chat/stream               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BACKEND: main.py                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  /agent/chat or /agent/chat/stream endpoint                            â”‚ â”‚
â”‚  â”‚  â€¢ Receives: {"messages": [{"role": "user", "content": "..."}]}       â”‚ â”‚
â”‚  â”‚  â€¢ Calls: run_agent_chat() or run_agent_chat_stream()                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AGENT LOOP: Iterative Tool Execution                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  run_agent_chat() - Main orchestration loop                            â”‚ â”‚
â”‚  â”‚                                                                          â”‚ â”‚
â”‚  â”‚  FOR EACH ITERATION (max 10):                                          â”‚ â”‚
â”‚  â”‚                                                                          â”‚ â”‚
â”‚  â”‚    1. BUILD PROMPT                                                      â”‚ â”‚
â”‚  â”‚       â”œâ”€ System Prompt (from llm.py)                                   â”‚ â”‚
â”‚  â”‚       â”œâ”€ Context (NG state summary + available data)                   â”‚ â”‚
â”‚  â”‚       â”œâ”€ Conversation History (user + assistant messages)              â”‚ â”‚
â”‚  â”‚       â””â”€ Current User Message                                          â”‚ â”‚
â”‚  â”‚                                                                          â”‚ â”‚
â”‚  â”‚    2. CALL LLM (OpenAI API)                                            â”‚ â”‚
â”‚  â”‚       â€¢ Model: gpt-4-turbo or configured model                         â”‚ â”‚
â”‚  â”‚       â€¢ Temperature: 0 for deterministic responses                     â”‚ â”‚
â”‚  â”‚       â€¢ Tools: Available tool schemas from llm.py                      â”‚ â”‚
â”‚  â”‚                                                                          â”‚ â”‚
â”‚  â”‚    3. PARSE RESPONSE                                                    â”‚ â”‚
â”‚  â”‚       â”œâ”€ Text message? â†’ Done, return to user                          â”‚ â”‚
â”‚  â”‚       â”œâ”€ Tool call(s)? â†’ Execute tools                                 â”‚ â”‚
â”‚  â”‚       â””â”€ Error? â†’ Return error message                                 â”‚ â”‚
â”‚  â”‚                                                                          â”‚ â”‚
â”‚  â”‚    4. EXECUTE TOOLS (if present)                                       â”‚ â”‚
â”‚  â”‚       â”œâ”€ Call tool_dispatcher()                                        â”‚ â”‚
â”‚  â”‚       â”œâ”€ Track mutations (NG state changes)                            â”‚ â”‚
â”‚  â”‚       â””â”€ Collect results                                               â”‚ â”‚
â”‚  â”‚                                                                          â”‚ â”‚
â”‚  â”‚    5. UPDATE HISTORY                                                    â”‚ â”‚
â”‚  â”‚       â”œâ”€ Add assistant message with tool calls                         â”‚ â”‚
â”‚  â”‚       â””â”€ Add tool results as tool messages                             â”‚ â”‚
â”‚  â”‚                                                                          â”‚ â”‚
â”‚  â”‚    6. CONTINUE LOOP                                                     â”‚ â”‚
â”‚  â”‚       â€¢ LLM sees tool results and can:                                 â”‚ â”‚
â”‚  â”‚         - Make more tool calls                                         â”‚ â”‚
â”‚  â”‚         - Provide final answer to user                                 â”‚ â”‚
â”‚  â”‚                                                                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RESPONSE AGGREGATION                                                        â”‚
â”‚  â€¢ Final assistant message                                                   â”‚
â”‚  â€¢ Mutation flag (if NG state changed)                                      â”‚
â”‚  â€¢ State link (if mutated)                                                   â”‚
â”‚  â€¢ Tool trace (execution history)                                           â”‚
â”‚  â€¢ Query data (if data_query executed)                                      â”‚
â”‚  â€¢ Plot data (if data_plot executed)                                        â”‚
â”‚  â€¢ NG views (if spatial query executed)                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FRONTEND RENDERING                                                          â”‚
â”‚  â€¢ Display assistant message                                                 â”‚
â”‚  â€¢ Render tables (Tabulator)                                                â”‚
â”‚  â€¢ Render plots (hvPlot)                                                     â”‚
â”‚  â€¢ Update Neuroglancer viewer (if mutated)                                  â”‚
â”‚  â€¢ Add to workspace                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ“ Prompt Construction (Growing Context)

### Iteration 1: Initial User Query

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PROMPT TO LLM (Iteration 1)                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  [SYSTEM PROMPT] (~2000 tokens)                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ You are a Neuroglancer assistant...                                   â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚ â€¢ Role description                                                     â”‚  â”‚
â”‚  â”‚ â€¢ Capabilities overview                                                â”‚  â”‚
â”‚  â”‚ â€¢ Tool usage guidelines                                                â”‚  â”‚
â”‚  â”‚ â€¢ Data manipulation examples (Polars expressions)                     â”‚  â”‚
â”‚  â”‚ â€¢ Aggregation patterns (group_by + agg)                               â”‚  â”‚
â”‚  â”‚ â€¢ Spatial data handling                                                â”‚  â”‚
â”‚  â”‚ â€¢ Plot generation guidelines                                           â”‚  â”‚
â”‚  â”‚ â€¢ Error handling expectations                                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚  [CONTEXT] (~500-1000 tokens)                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Current Neuroglancer State Summary:                                   â”‚  â”‚
â”‚  â”‚ â€¢ Layout: xy                                                           â”‚  â”‚
â”‚  â”‚ â€¢ Position: [1895.94, -2094.80, 689, 0]                              â”‚  â”‚
â”‚  â”‚ â€¢ Dimensions: x, y, z, t                                              â”‚  â”‚
â”‚  â”‚ â€¢ Layers: [CH_405, CH_488, CH_514]                                   â”‚  â”‚
â”‚  â”‚ â€¢ Annotation layers: []                                               â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚ Available Data Files:                                                  â”‚  â”‚
â”‚  â”‚ â€¢ cell_data_example.csv (1234 rows, 15 columns)                      â”‚  â”‚
â”‚  â”‚   - Columns: cell_id, x, y, z, volume, elongation, ...              â”‚  â”‚
â”‚  â”‚ â€¢ 767018_inh_cells.csv (5678 rows, 14 columns)                       â”‚  â”‚
â”‚  â”‚   - Columns: label, x_ccf, y_ccf, z_ccf, log_volume, ...            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚  [USER MESSAGE]                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ {"role": "user", "content": "Show me cells with volume > 100"}       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚  [TOOLS AVAILABLE] (Function schemas)                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ â€¢ ng_set_view(center, zoom, orientation)                              â”‚  â”‚
â”‚  â”‚ â€¢ ng_set_lut(layer, vmin, vmax)                                       â”‚  â”‚
â”‚  â”‚ â€¢ ng_add_layer(name, type, source)                                    â”‚  â”‚
â”‚  â”‚ â€¢ data_query(file_id, expression, spatial_columns)                   â”‚  â”‚
â”‚  â”‚ â€¢ data_plot(file_id, plot_type, x, y, expression, ...)              â”‚  â”‚
â”‚  â”‚ â€¢ data_list_files()                                                   â”‚  â”‚
â”‚  â”‚ â€¢ ... (15+ tools total)                                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚  TOTAL: ~2500-3500 tokens                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### LLM Response: Tool Call

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LLM RESPONSE (Iteration 1)                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  {                                                                           â”‚
â”‚    "role": "assistant",                                                      â”‚
â”‚    "content": null,                                                          â”‚
â”‚    "tool_calls": [                                                           â”‚
â”‚      {                                                                       â”‚
â”‚        "id": "call_abc123",                                                  â”‚
â”‚        "type": "function",                                                   â”‚
â”‚        "function": {                                                         â”‚
â”‚          "name": "data_query",                                               â”‚
â”‚          "arguments": {                                                      â”‚
â”‚            "file_id": "file_001",                                            â”‚
â”‚            "expression": "filter(pl.col('volume') > 100)",                  â”‚
â”‚            "spatial_columns": ["x", "y", "z"]                               â”‚
â”‚          }                                                                   â”‚
â”‚        }                                                                     â”‚
â”‚      }                                                                       â”‚
â”‚    ]                                                                         â”‚
â”‚  }                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Backend Executes Tool

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TOOL EXECUTION (Backend)                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  tool_dispatcher() â†’ execute_query()                                         â”‚
â”‚  â€¢ Load file_001 (cell_data_example.csv)                                    â”‚
â”‚  â€¢ Apply expression: filter(pl.col('volume') > 100)                         â”‚
â”‚  â€¢ Result: 456 rows Ã— 15 columns                                            â”‚
â”‚  â€¢ Generate ng_views for spatial navigation                                 â”‚
â”‚  â€¢ Return structured data                                                    â”‚
â”‚                                                                              â”‚
â”‚  Tool Result:                                                                â”‚
â”‚  {                                                                           â”‚
â”‚    "ok": true,                                                               â”‚
â”‚    "rows": 456,                                                              â”‚
â”‚    "columns": ["cell_id", "x", "y", "z", "volume", ...],                   â”‚
â”‚    "data": {...},  # DataFrame as dict                                      â”‚
â”‚    "ng_views": [{row_index: 0, url: "..."}, ...],                          â”‚
â”‚    "expression": "filter(pl.col('volume') > 100)"                           â”‚
â”‚  }                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Iteration 2: LLM Sees Tool Results

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PROMPT TO LLM (Iteration 2) - GROWING CONTEXT                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  [SYSTEM PROMPT] (~2000 tokens)                                             â”‚
â”‚  â€¢ Same as Iteration 1                                                       â”‚
â”‚                                                                              â”‚
â”‚  [CONTEXT] (~500-1000 tokens)                                               â”‚
â”‚  â€¢ Same as Iteration 1                                                       â”‚
â”‚                                                                              â”‚
â”‚  [CONVERSATION HISTORY] (~1000-2000 tokens) â† NEW!                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ {"role": "user", "content": "Show me cells with volume > 100"}       â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚ {"role": "assistant", "tool_calls": [                                â”‚  â”‚
â”‚  â”‚   {"function": {"name": "data_query", "arguments": {...}}}           â”‚  â”‚
â”‚  â”‚ ]}                                                                     â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚ {"role": "tool", "tool_call_id": "call_abc123",                      â”‚  â”‚
â”‚  â”‚  "content": "{\"ok\": true, \"rows\": 456, \"columns\": [...]}"}     â”‚  â”‚
â”‚  â”‚  # NOTE: Large data NOT sent to LLM! Only metadata                   â”‚  â”‚
â”‚  â”‚  # Actual data sent directly to frontend                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚  [TOOLS AVAILABLE]                                                           â”‚
â”‚  â€¢ Same list as before                                                       â”‚
â”‚                                                                              â”‚
â”‚  TOTAL: ~3500-5500 tokens (growing with history)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### LLM Response: Final Answer

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LLM RESPONSE (Iteration 2)                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  {                                                                           â”‚
â”‚    "role": "assistant",                                                      â”‚
â”‚    "content": "I found 456 cells with volume greater than 100. The         â”‚
â”‚                 results include spatial coordinates (x, y, z) for           â”‚
â”‚                 navigation in Neuroglancer. Click the View buttons to       â”‚
â”‚                 examine individual cells.",                                  â”‚
â”‚    "tool_calls": null                                                        â”‚
â”‚  }                                                                           â”‚
â”‚                                                                              â”‚
â”‚  â†’ Loop terminates, returns response to user                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ” Multi-Turn Conversation Example

### User Turn 1: "Load this state"

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Prompt Size: ~2.5K tok  â”‚  System + Context + "Load this state"
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tool: state_load()      â”‚  â†’ CURRENT_STATE updated
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Prompt Size: ~4K tok    â”‚  System + Context + History(2 msgs) + Tool Result
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
         "State loaded successfully"
```

### User Turn 2: "Show me the layers"

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Prompt Size: ~5K tok    â”‚  System + Context + History(3 msgs) + "Show layers"
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  No tool call            â”‚  LLM describes layers from context
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
         "You have 3 layers: CH_405, CH_488, CH_514"
```

### User Turn 3: "Upload data and plot volume by cluster"

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Prompt Size: ~6.5K tok  â”‚  System + Context + History(5 msgs) + "Upload..."
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tool 1: data_list_files â”‚  â†’ Get available files
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Prompt Size: ~8K tok    â”‚  + Tool result
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tool 2: data_plot()     â”‚  â†’ Generate plot
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Prompt Size: ~9.5K tok  â”‚  + Tool result
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
         "Here's a bar plot of mean volume by cluster..."
```

### Conversation Growth Pattern

```
Turn 1:  2.5K tokens  (System + Context + 1 user msg)
Turn 2:  4.0K tokens  (+ 2 assistant msgs + 1 tool result)
Turn 3:  5.0K tokens  (+ 1 user msg + 1 assistant msg)
Turn 4:  6.5K tokens  (+ 1 user msg)
Turn 5:  8.0K tokens  (+ 1 assistant msg + 1 tool result)
Turn 6:  9.5K tokens  (+ 1 assistant msg + 1 tool result)
...
```

**Growth rate**: ~1.5-2K tokens per turn with tool execution
**Context window**: GPT-4-turbo supports 128K tokens
**Typical conversation**: 10-20 turns before hitting limits

---

## ðŸ§© System Prompt Components

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SYSTEM PROMPT STRUCTURE (llm.py)                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  1. ROLE DEFINITION                                                          â”‚
â”‚     "You are a Neuroglancer assistant for neuroimaging visualization..."    â”‚
â”‚                                                                              â”‚
â”‚  2. CAPABILITIES                                                             â”‚
â”‚     â€¢ Navigate 3D volumes                                                    â”‚
â”‚     â€¢ Adjust layer visibility and contrast                                   â”‚
â”‚     â€¢ Query and analyze cell data                                           â”‚
â”‚     â€¢ Generate plots and visualizations                                      â”‚
â”‚     â€¢ Manage multi-view states                                               â”‚
â”‚                                                                              â”‚
â”‚  3. DATA MANIPULATION GUIDELINES                                             â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚     â”‚ "When querying data, use Polars expressions:                     â”‚   â”‚
â”‚     â”‚                                                                   â”‚   â”‚
â”‚     â”‚ Filtering:                                                        â”‚   â”‚
â”‚     â”‚   filter(pl.col('volume') > 100)                                 â”‚   â”‚
â”‚     â”‚   filter((pl.col('x') > 0) & (pl.col('y') < 1000))             â”‚   â”‚
â”‚     â”‚                                                                   â”‚   â”‚
â”‚     â”‚ Aggregation:                                                      â”‚   â”‚
â”‚     â”‚   group_by('cluster_label').agg(pl.mean('volume'))              â”‚   â”‚
â”‚     â”‚   group_by('region').agg([                                       â”‚   â”‚
â”‚     â”‚     pl.mean('volume').alias('mean_vol'),                        â”‚   â”‚
â”‚     â”‚     pl.count().alias('count')                                    â”‚   â”‚
â”‚     â”‚   ])                                                              â”‚   â”‚
â”‚     â”‚                                                                   â”‚   â”‚
â”‚     â”‚ Sorting:                                                          â”‚   â”‚
â”‚     â”‚   sort('volume', descending=True)                                â”‚   â”‚
â”‚     â”‚                                                                   â”‚   â”‚
â”‚     â”‚ Column selection:                                                 â”‚   â”‚
â”‚     â”‚   select(['cell_id', 'x', 'y', 'z', 'volume'])                  â”‚   â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  4. SPATIAL DATA HANDLING                                                    â”‚
â”‚     â€¢ Always preserve x, y, z columns                                        â”‚
â”‚     â€¢ Use spatial_columns parameter for navigation                           â”‚
â”‚     â€¢ Generate ng_views for clickable links                                  â”‚
â”‚                                                                              â”‚
â”‚  5. PLOT GENERATION EXAMPLES                                                 â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚     â”‚ Example 1: Simple bar plot                                       â”‚   â”‚
â”‚     â”‚   expression: "group_by('cluster').agg(pl.mean('volume'))"      â”‚   â”‚
â”‚     â”‚   x: 'cluster', y: 'volume'                                      â”‚   â”‚
â”‚     â”‚                                                                   â”‚   â”‚
â”‚     â”‚ Example 2: Scatter with filter                                   â”‚   â”‚
â”‚     â”‚   expression: "filter(pl.col('volume') > 50)"                   â”‚   â”‚
â”‚     â”‚   x: 'elongation', y: 'volume'                                   â”‚   â”‚
â”‚     â”‚                                                                   â”‚   â”‚
â”‚     â”‚ Example 3: Multi-step aggregation                                â”‚   â”‚
â”‚     â”‚   expression: "group_by('region').agg([                         â”‚   â”‚
â”‚     â”‚     pl.mean('log_volume').alias('mean_log_vol')                 â”‚   â”‚
â”‚     â”‚   ]).sort('mean_log_vol', descending=True)"                     â”‚   â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  6. TOOL USAGE RULES                                                         â”‚
â”‚     â€¢ Call data_list_files() before querying unknown files                  â”‚
â”‚     â€¢ Use data_info() to inspect file structure                             â”‚
â”‚     â€¢ Don't send large data to user - use tables/plots                      â”‚
â”‚     â€¢ Always check tool results before responding                           â”‚
â”‚                                                                              â”‚
â”‚  7. ERROR HANDLING                                                           â”‚
â”‚     â€¢ Validate file_id exists                                                â”‚
â”‚     â€¢ Check column names before filtering                                    â”‚
â”‚     â€¢ Provide helpful error messages                                         â”‚
â”‚     â€¢ Suggest corrections for common mistakes                                â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ› ï¸ Tool Schema Example

```json
{
  "type": "function",
  "function": {
    "name": "data_plot",
    "description": "Generate a plot from a data file. Supports scatter, line, bar, and heatmap plots with Polars expressions for data transformation.",
    "parameters": {
      "type": "object",
      "properties": {
        "file_id": {
          "type": "string",
          "description": "The file ID to plot from (use data_list_files to see available files)"
        },
        "plot_type": {
          "type": "string",
          "enum": ["scatter", "line", "bar", "heatmap"],
          "description": "Type of plot to generate"
        },
        "x": {
          "type": "string",
          "description": "Column name for x-axis"
        },
        "y": {
          "type": "string",
          "description": "Column name for y-axis (or list of columns)"
        },
        "expression": {
          "type": "string",
          "description": "Optional Polars expression to transform data before plotting. Examples: 'filter(pl.col(\"volume\") > 100)', 'group_by(\"cluster\").agg(pl.mean(\"volume\"))'"
        },
        "by": {
          "type": "string",
          "description": "Column to group by for colored/categorized plots. DO NOT use with aggregated bar plots."
        },
        "title": {
          "type": "string",
          "description": "Plot title"
        }
      },
      "required": ["file_id", "plot_type", "x", "y"]
    }
  }
}
```

---

## ðŸ“Š Memory & Context Management

### What Gets Saved in History?

```
âœ… INCLUDED IN HISTORY:
â€¢ User messages (full text)
â€¢ Assistant messages (full text)
â€¢ Tool call requests (function name + arguments)
â€¢ Tool results (metadata only - no large data)
  - Success/failure status
  - Row counts, column names
  - Error messages
  - Summary statistics

âŒ EXCLUDED FROM HISTORY:
â€¢ Large data payloads (sent directly to frontend)
â€¢ Plot HTML (generated client-side)
â€¢ Full dataframes (only metadata)
â€¢ Binary data (images, arrays)
```

### Context Pruning Strategy

Currently: **No automatic pruning** (relying on large context window)

Future considerations:
- Sliding window: Keep last N turns
- Importance-based: Keep tool calls, summarize text
- Compression: Summarize old conversations
- Checkpointing: Save state snapshots

---

## ðŸŽ¯ Tool Execution Patterns

### Pattern 1: Single Tool â†’ Answer

```
User: "Show layers"
  â†’ No tool call (info in context)
  â†’ Direct answer
```

### Pattern 2: Tool Chain

```
User: "Plot volume distribution"
  â†’ Tool 1: data_list_files() 
  â†’ Tool 2: data_plot()
  â†’ Answer with plot
```

### Pattern 3: Parallel Tools

```
User: "Show file info and current state"
  â†’ Tool 1: data_info()
  â†’ Tool 2: ng_state_summary()
  â†’ Synthesized answer
```

### Pattern 4: Error Recovery

```
User: "Plot invalid_column"
  â†’ Tool: data_plot() â†’ Error
  â†’ Tool: data_info() â†’ Get valid columns
  â†’ Suggest correction to user
```

### Pattern 5: Multi-View Generation

```
User: "Show me top 5 cells"
  â†’ Tool 1: data_query(limit=5)
  â†’ Tool 2: ng_generate_multi_view()
  â†’ NG state with 5 viewports
```

---

## ðŸ” Debugging & Observability

### Tool Trace Structure

```json
{
  "traces": [
    {
      "timestamp": "2025-10-21T10:30:45Z",
      "conversation_id": "conv_123",
      "mutated": true,
      "final_message": "I've updated the view to show...",
      "steps": [
        {
          "iteration": 1,
          "tool": "ng_set_view",
          "args": {"center": {"x": 100, "y": 200, "z": 300}},
          "result": {"ok": true},
          "duration_ms": 45
        },
        {
          "iteration": 2,
          "tool": "ng_set_lut",
          "args": {"layer": "CH_405", "vmin": 0, "vmax": 255},
          "result": {"ok": true},
          "duration_ms": 12
        }
      ]
    }
  ]
}
```

### Available Debug Endpoints

- `GET /debug/tool_trace?n=10` - Get last N tool traces
- `GET /debug/state` - Get current CURRENT_STATE
- `GET /debug/memory` - Get DataMemory statistics

---

## âš¡ Performance Characteristics

### Token Usage Per Request

| Component | Tokens | Notes |
|-----------|--------|-------|
| System Prompt | ~2000 | Static, cached by OpenAI |
| Context (NG state) | ~500 | Dynamic, changes with state |
| Context (Data files) | ~200-500 | Grows with uploaded files |
| User message | ~20-200 | Varies by query length |
| Tool call | ~50-150 | Function name + args |
| Tool result | ~100-500 | Metadata only |
| Assistant response | ~50-300 | Final answer |

**Average request**: 3K-6K tokens
**With long history (10 turns)**: 8K-12K tokens

### Latency Breakdown

```
Total Response Time: ~2-5 seconds

â€¢ Network (frontend â†’ backend): ~50ms
â€¢ Agent loop iteration:
  - LLM API call: ~1-2s (depends on response length)
  - Tool execution: ~50-500ms (depends on tool)
  - State serialization: ~10ms
â€¢ Network (backend â†’ frontend): ~50ms
â€¢ Frontend rendering: ~100-300ms
```

### Optimization Strategies

1. **Tool Result Truncation**: Send metadata, not full data
2. **Streaming**: Show responses as they're generated
3. **Context Caching**: OpenAI caches system prompt
4. **Parallel Tool Calls**: Multiple tools in one iteration
5. **Smart State Updates**: Only serialize on mutations

---

## ðŸŽ“ Example Conversations

### Example 1: Simple Query

```
User: "Show me 10 cells"

Prompt Size: 2.5K tokens
  â†’ Tool: data_query(limit=10)
Prompt Size: 4K tokens
  â†’ Response: "Here are 10 cells..."
  
Total: 1 iteration, 1 tool call
```

### Example 2: Complex Analysis

```
User: "Plot mean volume per cluster for cells with elongation > 2"

Prompt Size: 2.5K tokens
  â†’ Tool 1: data_list_files()
Prompt Size: 4K tokens
  â†’ Tool 2: data_plot(
      expression="filter(pl.col('elongation') > 2).group_by('cluster').agg(pl.mean('volume'))",
      plot_type="bar"
    )
Prompt Size: 5.5K tokens
  â†’ Response: "Here's a bar plot showing..."
  
Total: 2 iterations, 2 tool calls
```

### Example 3: Error & Recovery

```
User: "Plot invalid_col vs volume"

Prompt Size: 2.5K tokens
  â†’ Tool: data_plot() â†’ Error: "Column 'invalid_col' not found"
Prompt Size: 4K tokens
  â†’ Tool: data_info() â†’ Get valid columns
Prompt Size: 5.5K tokens
  â†’ Response: "The column 'invalid_col' doesn't exist. Available columns are..."
  
Total: 2 iterations, 2 tool calls (1 error)
```

---

## ðŸ”® Future Enhancements

### Planned Features

1. **Conversation Checkpointing**
   - Save/load conversation state
   - Resume sessions across restarts

2. **Smart Context Pruning**
   - Summarize old turns
   - Keep important tool calls
   - Sliding window with embeddings

3. **Tool Result Caching**
   - Cache expensive queries
   - Deduplicate identical calls
   - TTL-based invalidation

4. **Multi-Agent Collaboration**
   - Specialized agents (query, viz, analysis)
   - Agent routing based on intent
   - Collaborative responses

5. **Enhanced Memory**
   - Vector database for semantic search
   - User preference learning
   - Session-aware responses

---

## ðŸ“š Key Takeaways

âœ… **Agent uses iterative loop** with max 10 iterations
âœ… **Prompt grows** with conversation history + tool results
âœ… **System prompt** provides comprehensive guidelines (~2K tokens)
âœ… **Context includes** NG state + available data (~500-1K tokens)
âœ… **Tool results** truncated to metadata (no large payloads to LLM)
âœ… **History preserved** across turns for coherent conversation
âœ… **Streaming support** for real-time user feedback
âœ… **Observability** via tool traces and debug endpoints
