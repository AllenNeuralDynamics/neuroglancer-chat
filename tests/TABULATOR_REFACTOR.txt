"""
TABULATOR REFACTORING - COMPLETE
=================================

PROBLEM:
--------
Previous implementation had TWO table representations:
1. Markdown table in chat (truncated)
2. Interactive buttons below markdown table (duplicated data)
3. Full markdown table in workspace with more interactive buttons

This was inefficient, confusing, and required duplicate parsing/rendering.

SOLUTION:
---------
Use Panel's Tabulator widget for ALL table rendering:
âœ… Single table representation
âœ… Interactive View buttons built-in
âœ… Automatic horizontal scrolling for wide tables
âœ… Pagination for large datasets (>20 rows)
âœ… Consistent UI in chat and workspace
âœ… No markdown parsing/truncation complexity

WHAT CHANGED:
-------------

1. **Removed Functions:**
   - `_truncate_table_columns()` - No longer needed with Tabulator's scrolling
   - `_create_interactive_table()` - Replaced with Tabulator-based function
   
2. **New Function:** 
   - `_create_tabulator_from_markdown(text, ng_views, max_rows=500)`
     * Parses markdown table
     * Creates pandas DataFrame
     * Adds _ng_url column for View buttons
     * Returns Panel Tabulator widget with:
       - Button formatter for Actions column
       - on_click handler calling _load_internal_link(url)
       - Pagination if >20 rows
       - Appropriate height
       - Horizontal scrolling for wide tables

3. **Simplified agent_call():**
   - Removed truncation logic
   - Removed full_table/truncated_table tracking
   - Just returns enhanced table text + ng_views_raw

4. **Updated respond():**
   - Creates Tabulator widget directly from table text
   - Removes full_table_text variable
   - Single "Add to Workspace" button (not "View Full Table")
   - Yields Tabulator widget instead of Markdown pane

5. **Updated _add_result_to_workspace():**
   - Uses _create_tabulator_from_markdown()
   - Single tabulator widget, no conditional logic
   - No masking needed (_mask_client_side removed from workspace)

TABULATOR FEATURES USED:
-------------------------
âœ… **buttons**: {'_ng_url': '<i class="fa fa-eye"></i> View'}
   - Creates clickable icon button in Actions column
   
âœ… **on_click(callback)**: 
   - Handles button clicks
   - Extracts URL from DataFrame row
   - Calls _load_internal_link(url) to update viewer
   
âœ… **pagination**: "local" if >20 rows
   - Automatic client-side pagination
   - page_size=20
   
âœ… **layout**: "fit_data_table"
   - Automatic column width adjustment
   - Horizontal scrollbar for wide tables
   
âœ… **sizing_mode**: "stretch_width"
   - Responsive width in chat/workspace

BENEFITS:
---------
âœ… **Simpler Code**: Removed ~170 lines of truncation logic
âœ… **Better UX**: Native table controls (sort, scroll, paginate)
âœ… **Consistent**: Same widget in chat and workspace
âœ… **Performance**: Single DataFrame creation, no markdown re-parsing
âœ… **Maintainability**: One table implementation to maintain
âœ… **Scalability**: Handles 100s of rows with pagination

USER FLOW:
----------
1. User queries spatial data
2. Backend returns results + ng_views
3. Frontend creates Tabulator widget
4. Table appears in chat with:
   - All columns visible (horizontal scroll if needed)
   - Eye icon buttons in Actions column
   - Click button â†’ viewer updates in-place
5. "Add to Workspace" button creates same Tabulator in workspace
6. Both tables are identical, fully interactive

EXAMPLE:
--------
Query: "Show me 10 cells with coordinates"

Chat Response:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Tabulator Widget (interactive)                  â”‚
â”œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id â”‚  x  â”‚  y  â”‚ z  â”‚ value â”‚ Actions â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1  â”‚ 100 â”‚ 200 â”‚ 10 â”‚  5.5  â”‚  [ğŸ‘]   â”‚ â† Click to view
â”‚ 2  â”‚ 110 â”‚ 210 â”‚ 20 â”‚  6.5  â”‚  [ğŸ‘]   â”‚
â”‚ 3  â”‚ 120 â”‚ 220 â”‚ 30 â”‚  7.5  â”‚  [ğŸ‘]   â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
[ ğŸ“Š Add to Workspace ]

Workspace (after clicking button):
Same table, fully expanded, same functionality!

vs OLD IMPLEMENTATION:
----------------------
Chat (truncated):
```markdown
| id | x | y | ... | View |
|----|---|---|-----|------|
| 1  |100|200| ... | [view](url) |  â† Not clickable!
```
*Showing 5 of 14 columns*
**View Links:**
[View] [View] [View]  â† Separate buttons

Workspace (full):
```markdown
| id | x | y | z | centroid_x | ... | View |
|----|---|---|---|------------|-----|------|
| 1  |100|200|10 |    100     | ... | [view](url) |
```
**View Links:**
[View] [View] [View]  â† More duplicate buttons!

NEW IMPLEMENTATION:
-------------------
Both locations: Single Tabulator widget, all columns, clickable buttons!
"""
print(__doc__)
